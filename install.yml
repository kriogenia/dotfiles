---
- name: Install dotfiles
  hosts: localhost
  become: true
  vars:
    user: sotoestevez
    packages: # divide require and additional, also pacman vs yay
    - bat
    - eza
    - fish
    - fisher
    - fzf
    - markdownlint-cli2
    - nvim
    - pyenv
    - thefuck
    - tmux
    - yq
    configurations:
      - name: bat
        type: folder
      - name: cargo
        type: nested
        files:
          - .crates.toml
          - config.toml
      - name: eza
        type: folder
      - name: fish
        type: folder
      - name: gh
        type: folder
      - name: git
        type: file
        src: .gitconfig
        dest: .gitconfig
      - name: hypr
        type: folder
      - name: kitty
        type: folder
      - name: lazygit
        type: folder
      - name: nvim
        type: folder
      - name: qutebrowser
        type: folder
      - name: rustup
        type: nested
        files:
          - settings.toml
      - name: ssh
        type: nested
        files:
          - config
        folders:
          - config.d
      - name: tmux
        type: folder
      - name: wlogout
        type: folder

  tasks:

  - name: Install required packages
    pacman:
      name: "{{ packages }}"
      state: present
      update_cache: yes

  - name: Check for SDKMAN
    stat:
      path: "/home/{{ user }}/.sdkman"
    register: sdkman
    when: '"fish" in packages'
  - name: Install SDKMAN
    become_user: "{{ user }}"
    shell: |
        curl -s "https://get.sdkman.io" | bash
    when: not sdkman.stat.exists

  - name: Check .config directory
    become_user: "{{ user }}"
    file:
      name: "/home/{{ user }}/.config"
      state: directory
  - name: Symlink by folders
    include_tasks:
      file: playbooks/folder_symlink.yml
    loop: '{{ configurations | selectattr("type","equalto","folder") }}'
    loop_control:
      loop_var: configuration
      label: "{{ configuration.name }}"

  - name: Symlink by files
    include_tasks:
      file: playbooks/nested_symlink.yml
    loop: '{{ configurations | selectattr("type","equalto","nested") }}'
    loop_control:
      loop_var: configuration
      label: "{{ configuration.name }}"

  - name: Symlink by files
    include_tasks:
      file: playbooks/file_symlink.yml
    loop: '{{ configurations | selectattr("type","equalto","file") }}'
    loop_control:
      label: "{{ item.name }}"

